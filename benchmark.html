<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>BSA | Healthcare Design Benchmark Report Generator</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  :root{
    --bsa-red:#de1c28; --charcoal:#222426; --ink:#1a1c1e; --muted:#6d7178;
    --surface:#ffffff; --page:#f5f7f9; --stroke:#e6eaef; --focus:rgba(222,28,40,.30);
    --accent:#de1c28; --accent-2:#42464c; --accent-3:#a6adb6; --good:#19a974; --warn:#ffb700;
    --radius:12px; --shadow:0 1px 2px rgba(0,0,0,.04), 0 8px 30px rgba(0,0,0,.06); --lift:0 6px 16px rgba(0,0,0,.10);
  }
  @font-face{ font-family:"BSA Sans"; src:local("Helvetica Neue"),local("HelveticaNeue"),local("Helvetica"),local("Arial"); font-weight:100 900; font-style:normal; font-display:swap; }
  html,body{ height:100%; margin:0; background:var(--page); color:var(--ink);
    font-family:"BSA Sans",-apple-system,BlinkMacSystemFont,"Segoe UI","Helvetica Neue",Helvetica,Arial,sans-serif; -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale; }

  /* Header */
  .app-header{ background:var(--charcoal); color:#fff; box-shadow:var(--shadow); }
  .header-inner{ max-width:1120px; margin:0 auto; padding:12px 20px; display:flex; align-items:center; gap:16px; }
  .brand{ display:flex; align-items:center; gap:14px; min-width:0; flex:1; }
  .brand-logo{ height:40px; width:auto; display:block; }
  .brand-title{ font-size:24px; line-height:1; font-weight:750; letter-spacing:.2px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }

  /* Header actions */
  .header-actions{ margin-left:auto; position:relative; }
  .menu-btn{ appearance:none; border:0; background:transparent; color:#fff; width:40px; height:40px; border-radius:8px; display:grid; place-items:center; cursor:pointer; }
  .menu-btn:focus{ outline:none; box-shadow:0 0 0 3px var(--focus); }
  .menu-sheet{ position:absolute; right:0; top:44px; min-width:190px; background:#fff; color:var(--ink); border:1px solid var(--stroke); border-radius:10px; box-shadow:var(--lift); padding:8px; display:none; z-index:10; }
  .menu-sheet.open{ display:block; }
  .menu-item{ display:flex; align-items:center; gap:8px; width:100%; padding:10px; border-radius:8px; font-size:14px; background:transparent; border:0; cursor:pointer; }
  .menu-item:hover{ background:#f2f4f7; }
  .menu-icon{ width:18px; height:18px; color:var(--accent-2); }

  /* Shell */
  .container{ max-width:1120px; margin:24px auto; padding:24px; background:var(--surface); border-radius:var(--radius); box-shadow:var(--shadow); }
  h1{ margin:0 0 12px 0; font-size:22px; font-weight:700; letter-spacing:.2px; }
  .subtle{ margin:0 0 20px 0; color:var(--muted); font-size:14px; }

  /* Form */
  .form-section{ display:grid; grid-template-columns:1fr; gap:14px; margin-bottom:10px; }
  label{ font-size:13px; font-weight:600; }
  select{ width:100%; min-height:260px; border:1px solid var(--stroke); border-radius:8px; background:#fff; padding:10px; font-size:14px; outline:none; box-shadow:inset 0 1px 0 rgba(0,0,0,.02); }
  select:focus{ border-color:var(--accent); box-shadow:0 0 0 3px var(--focus); }
  option{ padding:6px; }

  /* Sections */
  #reportOutput{ display:block; margin-top:16px; }
  .report-section{ border:1px solid var(--stroke); border-radius:12px; padding:18px 18px 10px; background:#fff; box-shadow:var(--shadow); margin-bottom:16px; page-break-inside:avoid; }
  .section-head{ display:flex; align-items:center; justify-content:space-between; gap:16px; margin-bottom:6px; }
  .section-left{ display:flex; align-items:center; gap:10px; }
  .report-title{ font-size:18px; font-weight:800; margin:0; letter-spacing:.2px; }
  .tag{ font-size:12px; color:#fff; background:var(--accent-2); padding:4px 8px; border-radius:999px; white-space:nowrap; }
  .updated{ font-size:12px; color:var(--muted); white-space:nowrap; }
  .report-desc{ margin:6px 0 12px 0; color:var(--muted); font-size:14px; line-height:1.5; }

  /* Legend */
  .legend{ display:flex; flex-wrap:wrap; gap:10px 14px; margin:0 0 10px 0; padding:0; list-style:none; }
  .legend-item{ display:inline-flex; align-items:center; gap:6px; font-size:12px; color:var(--accent-2); }
  .chip{ width:12px; height:12px; border-radius:3px; display:inline-block; border:1px solid rgba(0,0,0,.08); box-shadow: inset 0 1px 0 rgba(255,255,255,.4); }
  .chip.red{ background:var(--accent); } .chip.charcoal{ background:var(--accent-2); } .chip.gray{ background:var(--accent-3); }
  .chip.good{ background:var(--good); } .chip.warn{ background:var(--warn); }

  /* Viz grid */
  .viz-grid{ display:grid; grid-template-columns:1fr; gap:12px; }
  @media (min-width:760px){ .viz-grid{ grid-template-columns:repeat(12,1fr); } }
  .viz{ position:relative; border:1px solid var(--stroke); border-radius:10px; padding:10px; background:#fff; transition:transform .12s ease, box-shadow .12s ease; }
  .viz:hover{ transform:translateY(-1px); box-shadow:var(--lift); }
  .viz.half,.viz.third,.viz.two,.viz.full{ grid-column:span 12; }
  @media (min-width:760px){ .viz.half{ grid-column:span 6; } .viz.third{ grid-column:span 4; } .viz.two{ grid-column:span 8; } .viz.full{ grid-column:span 12; } }
  .viz h4{ margin:0 0 8px 0; font-size:13px; text-transform:uppercase; letter-spacing:.08em; color:var(--accent-2); }

  /* Mini tool bits */
  .kpis{ display:grid; grid-template-columns:repeat(2,1fr); gap:8px; }
  @media (min-width:760px){ .kpis{ grid-template-columns:repeat(4,1fr); } }
  .kpi{ border:1px dashed var(--stroke); border-radius:10px; padding:10px; display:flex; flex-direction:column; gap:2px; background:#fff; }
  .kpi .label{ font-size:11px; color:var(--muted); text-transform:uppercase; letter-spacing:.08em; }
  .kpi .value{ font-size:22px; font-weight:800; }
  .kpi.good .value{ color:var(--good); } .kpi.warn .value{ color:var(--accent); }
  .mini-form{ display:flex; flex-wrap:wrap; gap:10px 12px; align-items:flex-end; }
  .mini-form .f{ display:flex; flex-direction:column; gap:4px; }
  .mini-form label{ font-size:11px; color:var(--muted); }
  .mini-form input{ width:140px; padding:8px 10px; border:1px solid var(--stroke); border-radius:8px; font:inherit; font-size:14px; outline:none; }
  .mini-form input:focus{ border-color:var(--accent); box-shadow:0 0 0 3px var(--focus); }
  .mini-out{ margin-left:auto; font-weight:800; font-size:18px; }
  .mini-note{ font-size:12px; color:var(--muted); margin-top:6px; }
  .bar-wrap{ margin-top:8px; border:1px solid var(--stroke); border-radius:999px; overflow:hidden; height:10px; }
  .bar{ height:100%; background:var(--accent); width:0%; transition:width .2s ease; }

  /* 7 flows tiles */
  .flow-grid{ display:grid; grid-template-columns:1fr; gap:10px; }
  @media (min-width:760px){ .flow-grid{ grid-template-columns:repeat(2,1fr); } }
  .flow-tile{
    display:flex; gap:12px; align-items:flex-start; padding:14px;
    border:1px solid var(--stroke); border-radius:12px; background:#fff; box-shadow:var(--shadow);
    position:relative; overflow:hidden;
  }
  .flow-tile::before{
    content:""; position:absolute; inset:0; background:
      radial-gradient(120px 120px at 0% 0%, rgba(66,70,76,.05), transparent 60%);
    pointer-events:none;
  }
  .flow-icon{
    width:36px; height:36px; border-radius:999px; display:grid; place-items:center; color:#fff; font-weight:800;
  }
  .flow-title{ font-weight:800; letter-spacing:.02em; }
  .flow-desc{ color:var(--muted); margin-top:2px; font-size:14px; }
  .bg-red{ background:#de1c28; } .bg-blue{ background:#4f6dbd; } .bg-orange{ background:#ee9b2f; }
  .bg-teal{ background:#37b0a6; } .bg-green{ background:#30b24a; } .bg-gray{ background:#8a8f98; }
  .bg-cyan{ background:#26a6cf; }

  /* Print */
  @media print{
    @page{ margin:16mm; }
    *{ -webkit-print-color-adjust:exact !important; print-color-adjust:exact !important; }
    .app-header,.form-section{ display:none !important; }
    body{ background:#fff !important; }
    .container{ box-shadow:none !important; padding:0 !important; }
    .viz::before{ display:none !important; }
    #print-footer{ position:fixed; left:0; right:0; bottom:8mm; text-align:center; font-size:11px; color:#6b6f76; }
  }
</style>
</head>
<body>
  <header class="app-header">
    <div class="header-inner">
      <div class="brand" aria-label="BSA LifeStructures">
        <!-- BSA SVG -->
        <svg class="brand-logo" viewBox="0 0 960 489.48" xmlns="http://www.w3.org/2000/svg" aria-label="BSA Logo" role="img">
          <g fill="#de1c28">
            <path d="M293.75,274.14c-18.01-17.42-43.03-29.48-74.49-35.97,10.29-3.5,19.76-7.87,28.31-13.06,12.42-7.55,23.01-16.55,31.47-26.76,8.49-10.23,15.1-21.55,19.63-33.64,4.55-12.12,6.86-24.88,6.86-37.94,0-19.6-3.3-37.44-9.8-53.02-6.55-15.65-16.73-29.1-30.28-39.96-13.45-10.79-30.68-19.07-51.24-24.62C193.81,3.67,169.47.89,141.87.89H0v488.17h159.56c25.83,0,49.28-3.08,69.68-9.16,20.53-6.11,38.1-15.08,52.22-26.65,14.19-11.63,25.15-26.02,32.59-42.76,7.42-16.69,11.19-35.7,11.19-56.5,0-32.78-10.59-59.65-31.5-79.85ZM41.9,35.3h99.98c41.85,0,73.1,8.15,92.9,24.23,19.59,15.9,29.52,39.78,29.52,70.98,0,12-2.32,23.81-6.9,35.11-4.54,11.26-11.75,21.49-21.42,30.39-9.7,8.94-22.36,16.26-37.61,21.75-15.31,5.51-34.09,8.3-55.81,8.3H41.9V35.3ZM252.76,427.72c-20.92,17.63-52.4,26.58-93.55,26.58H41.9v-195.87h117.67c19.75,0,37.63,2.24,53.13,6.67,15.39,4.4,28.5,10.78,38.97,18.96,10.41,8.14,18.49,18.14,24.01,29.73,5.53,11.59,8.34,24.88,8.34,39.51,0,31.89-10.51,56.93-31.25,74.42Z"/>
            <path d="M760.26.89h-38.97l-199.75,488.17h31.64c3.97,0,7.43-1.17,10.31-3.47,2.77-2.21,4.73-4.9,5.8-7.86l55.59-137.65h231.77l55.61,137.69c1.35,3.24,3.28,5.91,5.74,7.94,2.66,2.22,6.03,3.35,10.01,3.35h31.98L760.26.89ZM633.11,310.79l97.96-242.86c1.82-4.08,3.52-8.56,5.1-13.44,1.59-4.88,3.07-10.04,4.42-15.48,3.18,11.11,6.46,20.64,9.86,28.57l97.96,243.2h-215.31Z"/>
            <g><path d="M558.1,287.83l-14.66-7.98c-9.68-5.11-20.2-9.77-31.25-13.83-11.28-4.15-22.99-8.05-34.8-11.6-12.38-3.71-24.67-7.86-36.49-12.33-12.2-4.61-23.83-9.92-34.54-15.8-11.41-6.26-21.56-13.98-30.16-22.97-8.87-9.23-15.97-20.34-21.1-33.01-5.15-12.66-7.76-27.65-7.76-44.54s3.11-32.42,9.25-47.51c6.17-15.19,15.31-28.78,27.17-40.39,11.8-11.55,26.46-20.86,43.58-27.67,17.05-6.76,36.66-10.2,58.29-10.2,24.14,0,45.94,4.02,64.79,11.95,18.91,7.95,36.81,20.66,53.2,37.76l7.6,7.93-7.14,10.75c-2.98,5.24-8.62,8.48-14.98,8.48-5.25,0-10.17-2.26-15.06-6.91-2.13-2.03-4.91-4.59-8.33-7.7-3.1-2.8-7.08-5.97-11.85-9.43-4.35-3.15-9.77-6.15-16.09-8.93-6.38-2.8-13.95-5.18-22.49-7.07-8.42-1.86-18.4-2.8-29.65-2.8-17.05,0-32.26,2.61-45.17,7.76-12.85,5.12-23.7,11.95-32.23,20.29-8.49,8.3-15.03,18.04-19.45,28.95-4.48,11.03-6.75,22.71-6.75,34.72,0,15.24,2.86,27.88,8.51,37.57,5.93,10.16,13.8,18.84,23.39,25.79,10.14,7.36,22.01,13.59,35.28,18.51,14.26,5.29,28.96,10.45,43.7,15.32,15,4.97,30.04,10.3,44.7,15.85,7.88,2.99,15.48,6.47,22.6,10.36l10.55,5.76-12.65,32.89Z"/>
            <path d="M470.51,489.48h-9.6c-16.61,0-31.74-1.49-44.94-4.44-13.35-2.98-25.79-7.35-36.98-13-10.81-5.46-20.95-12.19-30.16-20l-11.16-9.47 10.17-10.53c1.15-1.19,2.2-2.48,3.25-3.75l10.21-12.24 10.54,8.94c1.94,1.64,3.94,3.32,6.14,5.04,5.37,4.22,12.08,8.3,19.96,12.15,7.85,3.83,17.07,7.04,27.37,9.54,10.19,2.48,22.13,3.74,35.48,3.74l2.61-.12,20.35-.35-13.25,34.5Z"/></g>
          </g>
        </svg>
        <div class="brand-title">Benchmark Tools</div>
      </div>

      <div class="header-actions">
        <button class="menu-btn" id="menuBtn" aria-haspopup="true" aria-expanded="false" title="Menu">
          <svg viewBox="0 0 24 24" width="22" height="22" fill="currentColor" aria-hidden="true">
            <rect x="3" y="6"  width="18" height="2" rx="1"></rect>
            <rect x="3" y="11" width="18" height="2" rx="1"></rect>
            <rect x="3" y="16" width="18" height="2" rx="1"></rect>
          </svg>
        </button>

        <div class="menu-sheet" id="menuSheet" role="menu" aria-label="Actions">
          <button class="menu-item" id="printBtn" role="menuitem">
            <svg class="menu-icon" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
              <path d="M6 3h12v5H6zM6 14h12v7H6z"/><path d="M4 10h16a2 2 0 0 1 2 2v3H2v-3a2 2 0 0 1 2-2z"/>
            </svg>
            Print to PDF
          </button>
        </div>
      </div>
    </div>
  </header>

  <main class="container">
    <h1>Healthcare Design Benchmark Report Generator</h1>
    <p class="subtle">Full-width stacked sections with branded visuals, legends, timestamps, and interactive mini tools.</p>

    <div class="form-section">
      <label for="categories" class="kicker">Benchmark Categories</label>
      <select id="categories" multiple size="10">
        <option value="Patient Care" selected>Patient Care</option>
        <option value="Medication Management">Medication Management</option>
        <option value="Evidence-Based Design">Evidence-Based Design</option>
        <option value="IT & Technology">IT & Technology</option>
        <option value="Building Metrics">Building Metrics</option>
        <option value="Staff Safety">Staff Safety</option>
        <option value="Family Experience">Family Experience</option>
        <option value="Supply Chain">Supply Chain</option>
        <option value="Clinical Metrics">Clinical Metrics</option>
      </select>
    </div>

    <section id="reportOutput" aria-live="polite"></section>
  </main>

  <div id="print-footer" aria-hidden="true">
    Generated using the BSA Intelligence Suite - BSA Benchmark Tools
  </div>

<script>
/* ===== Helpers & Tiny Charts (expanded palette) ===== */
const LAST_UPDATED = new Date().toLocaleDateString([], {year:'numeric', month:'short', day:'2-digit'});
const slug = s => s.toLowerCase().replace(/[^a-z0-9]+/g,'-');
const legend = items => `<ul class="legend">${items.map(i=>`<li class="legend-item"><span class="chip ${i.color}"></span>${i.label}</li>`).join('')}</ul>`;

/* Core color tokens used inside SVG where CSS vars apply */
const C = {
  accent: 'var(--accent)', ink:'var(--ink)', grid:'var(--accent-3)',
  good:'var(--good)', warn:'var(--warn)', neutral:'var(--accent-3)', fg:'var(--accent-2)'
};

/* Simple bar (kept) */
function barChart(v=[30,60,45,80,50],max=100){
  const w=260,h=100,p=16,bw=(w-2*p)/v.length-6;
  return `<svg viewBox="0 0 ${w} ${h}" width="100%" height="120">
    <rect x="0" y="0" width="${w}" height="${h}" fill="#fff"/>
    ${v.map((x,i)=>{const bh=(h-26)*(x/max); return `<rect x="${p+i*(bw+6)}" y="${h-10-bh}" width="${bw}" height="${bh}" rx="3" fill="${C.accent}"></rect>`}).join('')}
    <line x1="${p}" y1="${h-10}" x2="${w-p}" y2="${h-10}" stroke="${C.grid}" stroke-width="1"/>
  </svg>`;
}

/* Sparkline (kept) */
function sparkline(points=[5,9,6,10,7,12,8]){
  const w=260,h=60,p=6,dx=(w-2*p)/(points.length-1);
  const mx=Math.max(...points),mn=Math.min(...points);
  const y=v=>h-p-((v-mn)/(mx-mn||1))*(h-2*p);
  return `<svg viewBox="0 0 ${w} ${h}" width="100%" height="70">
    <polyline points="${points.map((v,i)=>`${p+i*dx},${y(v)}`).join(' ')}" fill="none" stroke="${C.accent}" stroke-width="2"/>
  </svg>`;
}

/* Donut (kept) */
function donut(pct=72,label="Utilization"){
  const r=40,cx=55,cy=55,circ=2*Math.PI*r,off=circ*(1-pct/100);
  return `<svg viewBox="0 0 110 110" width="110" height="110">
    <circle cx="${cx}" cy="${cy}" r="${r}" fill="none" stroke="${C.neutral}" stroke-width="12" opacity=".35"/>
    <circle cx="${cx}" cy="${cy}" r="${r}" fill="none" stroke="${C.accent}" stroke-width="12" stroke-dasharray="${circ} ${circ}" stroke-dashoffset="${off}" transform="rotate(-90 ${cx} ${cy})"/>
    <text x="${cx}" y="${cy-2}" text-anchor="middle" font-size="18" font-weight="800">${pct}%</text>
    <text x="${cx}" y="${cy+16}" text-anchor="middle" font-size="9" fill="var(--muted)">${label}</text>
  </svg>`;
}

/* NEW: Area chart */
function areaChart(points=[10,18,12,22,16,26,20]){
  const w=260,h=100,p=10,dx=(w-2*p)/(points.length-1);
  const mx=Math.max(...points),mn=Math.min(...points);
  const y=v=>h-p-((v-mn)/(mx-mn||1))*(h-2*p);
  const line=points.map((v,i)=>`${p+i*dx},${y(v)}`).join(' ');
  return `<svg viewBox="0 0 ${w} ${h}" width="100%" height="110">
    <polyline points="${p},${h-p} ${line} ${w-p},${h-p}" fill="rgba(222,28,40,.15)" stroke="none"/>
    <polyline points="${line}" fill="none" stroke="${C.accent}" stroke-width="2"/>
  </svg>`;
}

/* NEW: Lollipop chart */
function lollipopChart(values=[55,85,60,90,75],max=100){
  const w=300,h=120,p=24,step=(w-2*p)/(values.length-1);
  return `<svg viewBox="0 0 ${w} ${h}" width="100%" height="120">
    ${values.map((v,i)=>{const x=p+i*step,y=h-20,tx=p+i*step; const len=(v/max)*(w-2*p); return `
      <line x1="${p}" y1="${y}" x2="${p+len}" y2="${y}" stroke="${C.neutral}" stroke-width="2" opacity=".5"/>
      <circle cx="${p+len}" cy="${y}" r="6" fill="${C.accent}"/>
    `}).join('')}
  </svg>`;
}

/* NEW: Bullet chart (target vs actual) */
function bulletChart(actual=72,target=85,max=100,label="Performance"){
  const w=300,h=40,p=10,aw=(actual/max)*(w-2*p),tw=(target/max)*(w-2*p);
  return `<svg viewBox="0 0 ${w} ${h}" width="100%" height="54">
    <rect x="${p}" y="14" width="${w-2*p}" height="12" rx="6" fill="rgba(0,0,0,.06)"/>
    <rect x="${p}" y="16" width="${aw}" height="8" rx="4" fill="${C.accent}"/>
    <line x1="${p+tw}" y1="12" x2="${p+tw}" y2="28" stroke="${C.fg}" stroke-width="2"/>
    <text x="${p}" y="10" font-size="10" fill="var(--muted)">${label}</text>
  </svg>`;
}

/* NEW: Stacked bar (categories across segments) */
function stackedBar(stacks=[[30,20,10],[10,15,35],[25,5,20]],max=70){
  const colors=[C.accent,'var(--good)','var(--accent-2)'];
  const w=300,h=120,p=16,bh=20,g=12;
  return `<svg viewBox="0 0 ${w} ${h}" width="100%" height="120">
    ${stacks.map((arr,i)=>{
      let x=p,y=p+i*(bh+g);
      const total=arr.reduce((a,b)=>a+b,0);
      return arr.map((v,j)=>{
        const wSeg=((v)/max)*(w-2*p);
        const rect=`<rect x="${x}" y="${y}" width="${wSeg}" height="${bh}" rx="4" fill="${colors[j%colors.length]}" opacity="${0.9-j*0.1}"></rect>`;
        x+=wSeg; return rect;
      }).join('');
    }).join('')}
  </svg>`;
}

/* NEW: Heatmap grid */
function heatmap(matrix=[[2,4,6,3,1],[1,2,5,6,4],[3,5,6,2,1]],scale=6){
  const w=260,h=100,p=8,rows=matrix.length,cols=matrix[0].length,cellW=(w-2*p)/cols,cellH=(h-2*p)/rows;
  return `<svg viewBox="0 0 ${w} ${h}" width="100%" height="110">
    ${matrix.flatMap((row,r)=>row.map((v,c)=>{
      const o=0.2+(v/scale)*0.7;
      return `<rect x="${p+c*cellW}" y="${p+r*cellH}" width="${cellW-2}" height="${cellH-2}" rx="3" fill="${C.accent}" opacity="${o}"></rect>`;
    })).join('')}
  </svg>`;
}

/* NEW: Radar chart */
function radarChart(series=[0.7,0.55,0.9,0.6,0.8],labels=["Air","Noise","Light","Temp","Clean"]){
  const size=140,cx=size/2,cy=size/2,r=58,axes=series.length;
  const angle=i=>-Math.PI/2 + (2*Math.PI*i/axes);
  const pts = series.map((v,i)=>`${cx+r*v*Math.cos(angle(i))},${cy+r*v*Math.sin(angle(i))}`).join(' ');
  return `<svg viewBox="0 0 ${size} ${size}" width="100%" height="160">
    ${[0.3,0.6,1].map(t=>`<polygon points="${labels.map((_,i)=>`${cx+r*t*Math.cos(angle(i))},${cy+r*t*Math.sin(angle(i))}`).join(' ')}" fill="none" stroke="${C.neutral}" opacity="${0.4}" />`).join('')}
    <polygon points="${pts}" fill="rgba(222,28,40,.18)" stroke="${C.accent}" stroke-width="2"/>
  </svg>`;
}

/* NEW: Semi gauge */
function gaugeSemi(pct=76,label="Utilization"){
  const w=180,h=100,cx=w/2,cy=h, r=78, a=-Math.PI, b=0, t=a+(b-a)*pct/100;
  const arc=(ang)=>`${cx+r*Math.cos(ang)},${cy+r*Math.sin(ang)}`;
  const path=`M ${arc(a)} A ${r} ${r} 0 0 1 ${arc(b)}`;
  const needle=`M ${cx} ${cy} L ${cx+r*Math.cos(t)} ${cy+r*Math.sin(t)}`;
  return `<svg viewBox="0 0 ${w} ${h+10}" width="100%" height="120">
    <path d="${path}" fill="none" stroke="${C.neutral}" stroke-width="12" opacity=".35"/>
    <path d="${path}" fill="none" stroke="${C.accent}" stroke-width="12" stroke-dasharray="${Math.PI*r} ${Math.PI*r}" stroke-dashoffset="${(1-pct/100)*Math.PI*r}"/>
    <line x1="${cx}" y1="${cy}" x2="${cx+r*Math.cos(t)}" y2="${cy+r*Math.sin(t)}" stroke="${C.fg}" stroke-width="3"/>
    <circle cx="${cx}" cy="${cy}" r="4" fill="${C.fg}"/>
    <text x="${cx}" y="${h-8}" text-anchor="middle" font-size="12" fill="var(--muted)">${label} • ${pct}%</text>
  </svg>`;
}

/* NEW: Waterfall chart */
function waterfall(values=[-50,120,30,-20,40], labels=["Cost","Savings","Productivity","Maint.","Net"]){
  const w=300,h=140,p=18,bw=28,g=10;
  const min=Math.min(0,values.reduce((acc,v,i)=>i<labels.length-1?Math.min(acc,acc+v):acc,0));
  const max=Math.max(...[...values.reduce((a,v,i)=>{a.push((a[i-1]||0)+v); return a;},[])]);
  const scale=v=>p+(h-40)*((max-v)/(max-min||1));
  let running=0;
  return `<svg viewBox="0 0 ${w} ${h}" width="100%" height="150">
    ${values.map((v,i)=>{
      const y0=scale(running), y1=scale(running+v);
      const y=Math.min(y0,y1), height=Math.max(2,Math.abs(y1-y0));
      const x=p+i*(bw+g);
      running+=v;
      const col=v>=0?C.good:C.accent;
      return `<rect x="${x}" y="${y}" width="${bw}" height="${height}" rx="4" fill="${col}"></rect>`;
    }).join('')}
  </svg>`;
}

/* NEW: Waffle chart */
function waffle(pct=73, size=10){
  const total=size*size, filled=Math.round(total*pct/100), cell=12, p=6, w=size*cell+2*p, h=w;
  return `<svg viewBox="0 0 ${w} ${h}" width="100%" height="${h}">
    ${Array.from({length:total}).map((_,i)=>{
      const r=Math.floor(i/size), c=i%size, x=p+c*cell, y=p+r*cell;
      const fill=i<filled?C.accent:'rgba(0,0,0,.06)';
      return `<rect x="${x}" y="${y}" width="${cell-2}" height="${cell-2}" rx="2" fill="${fill}"></rect>`;
    }).join('')}
  </svg>`;
}

/* Progress bar utility */
function progressBar(id,pct){const el=document.getElementById(id); if(el) el.style.width=Math.max(0,Math.min(100,pct))+'%';}

/* ===== Calculators (unchanged) ===== */
function factorial(n){let r=1; for(let i=2;i<=n;i++) r*=i; return r;}
function erlangC(lambda,mu,s){if(mu<=0||s<=0||lambda<=0) return {Wq_min:0,W_min:0,rho:0,valid:false}; const a=lambda/mu,rho=a/s; if(rho>=1) return {Wq_min:Infinity,W_min:Infinity,rho,valid:false}; let sum=0; for(let k=0;k<s;k++) sum+=Math.pow(a,k)/factorial(k); const term=Math.pow(a,s)/(factorial(s)*(1-rho)); const P0=1/(sum+term); const Pc=term*P0; const Wq=Pc/(s*mu-lambda); const W=Wq+1/mu; return {Wq_min:Wq*60,W_min:W*60,rho,valid:true};}
function staffingCalc(p){const a=+document.getElementById(`${p}-staff-arr`).value||0; const sT=+document.getElementById(`${p}-staff-svc`).value||0; const u=+document.getElementById(`${p}-staff-util`).value||85; const d=a*(sT/60); const need=sT>0?Math.ceil(d/(u/100)):0; const cap=sT>0?(60/sT):0; document.getElementById(`${p}-staff-out`).textContent=`${need} provider${need===1?'':'s'}`; progressBar(`${p}-staff-bar`, sT? Math.min(100,(d/(need||1))*(100/u)):0); document.getElementById(`${p}-staff-note`).textContent=`At ${u}% util and ${a}/hr demand, each provider sees ~${cap.toFixed(1)} pts/hr.`;}
function waitCalc(p){const lam=+document.getElementById(`${p}-wait-arr`).value||0; const sT=+document.getElementById(`${p}-wait-svc`).value||0; const s=+document.getElementById(`${p}-wait-srv`).value||1; const mu=sT>0?60/sT:0; const {Wq_min,W_min,rho,valid}=erlangC(lam,mu,s); const out=document.getElementById(`${p}-wait-out`), note=document.getElementById(`${p}-wait-note`); if(!valid){out.textContent='Unstable (ρ ≥ 1)'; note.textContent='Increase providers or reduce demand/service time.'; progressBar(`${p}-wait-bar`,100); return;} out.textContent=`${Wq_min.toFixed(1)} min wait (total ${W_min.toFixed(1)} min)`; note.textContent=`ρ = ${(rho*100).toFixed(1)}% · Erlang-C`; progressBar(`${p}-wait-bar`, Math.min(100,(Wq_min/60)*100));}
function pickCalc(p){const orders=+document.getElementById(`${p}-pick-ord`).value||0, items=+document.getElementById(`${p}-pick-itm`).value||0, sec=+document.getElementById(`${p}-pick-sec`).value||0, walk=+document.getElementById(`${p}-pick-walk`).value||0, staff=+document.getElementById(`${p}-pick-staff`).value||1; const demand=orders*items; const perTech=sec>0?(3600/(sec+(walk/items||0))):0; const cap=perTech*staff; const need=perTech>0?Math.ceil(demand/perTech):0; document.getElementById(`${p}-pick-out1`).textContent=`${Math.round(perTech)} picks/tech·hr`; document.getElementById(`${p}-pick-out2`).textContent=`${Math.round(cap)} capacity picks/hr`; document.getElementById(`${p}-pick-out3`).textContent=`${need} tech${need===1?'':'s'} needed`; progressBar(`${p}-pick-bar`, cap?Math.min(100,(demand/cap)*100):0); document.getElementById(`${p}-pick-note`).textContent=`Demand ${demand}/hr vs capacity ${Math.round(cap)}/hr`; }
function roiCalc(p){const cost=+document.getElementById(`${p}-roi-cost`).value||0, sav=+document.getElementById(`${p}-roi-sav`).value||0, yrs=+document.getElementById(`${p}-roi-yrs`).value||1, disc=(+document.getElementById(`${p}-roi-disc`).value||0)/100; const pay=sav>0?(cost/sav):Infinity; let npv=-cost; for(let t=1;t<=yrs;t++) npv+=sav/Math.pow(1+disc,t); const sROI=cost>0?((sav*yrs-cost)/cost)*100:0; document.getElementById(`${p}-roi-out1`).textContent=isFinite(pay)?`${pay.toFixed(1)} yrs`:'—'; document.getElementById(`${p}-roi-out2`).textContent=`$${Math.round(npv).toLocaleString()}`; document.getElementById(`${p}-roi-out3`).textContent=`${sROI.toFixed(0)}% ROI`; progressBar(`${p}-roi-bar`, npv>0?100:0); document.getElementById(`${p}-roi-note`).textContent=`NPV over ${yrs} yrs @ ${disc*100}% discount.`;}
function uptimeCalc(p){const up=+document.getElementById(`${p}-up-upt`).value||0, days=+document.getElementById(`${p}-up-days`).value||30; const down=(1-up/100)*days*24*60; document.getElementById(`${p}-up-out`).textContent=Math.round(down)+' min'; progressBar(`${p}-up-bar`, Math.min(100,(down/(days*24*60))*100)); document.getElementById(`${p}-up-note`).textContent=`Over ${days} days at ${up}% uptime.`;}
function achCalc(p){const L=+document.getElementById(`${p}-ach-len`).value||0,W=+document.getElementById(`${p}-ach-wid`).value||0,H=+document.getElementById(`${p}-ach-ht`).value||0,cfm=+document.getElementById(`${p}-ach-cfm`).value||0; const vol=L*W*H, ach=vol?(cfm*60)/vol:0; document.getElementById(`${p}-ach-out`).textContent=ach.toFixed(1)+' ACH'; progressBar(`${p}-ach-bar`, Math.min(100,(ach/12)*100)); document.getElementById(`${p}-ach-note`).textContent=`Volume ${vol.toLocaleString()} ft³ (target 12 ACH)`;}

/* ===== “7 flows” tiles ===== */
function flowsTiles(){
  const items=[
    {k:'PATIENT',desc:'Processes that directly impact patient care.', cls:'bg-red',   icon:'🛏️'},
    {k:'PROVIDERS / STAFF / SAFETY',desc:'Processes that impact providers or occur between providers.', cls:'bg-blue', icon:'👩‍⚕️'},
    {k:'FAMILIES',desc:'Processes that impact families and visitors.', cls:'bg-orange', icon:'👪'},
    {k:'SUPPLIES',desc:'Supply delivery, stocking, storage, and management.', cls:'bg-green', icon:'📦'},
    {k:'MEDICATION',desc:'Guides medication storage, controls, and administration.', cls:'bg-cyan', icon:'💊'},
    {k:'EQUIPMENT / LAB / BLOOD BANK',desc:'Equipment cleaning, storage, procurement, management.', cls:'bg-teal', icon:'🧪'},
    {k:'INFORMATION / IT / TECHNOLOGY / DOWNTIME',desc:'How information is disseminated or managed across channels.', cls:'bg-gray', icon:'🖥️'}
  ];
  return `<div class="viz full">
    <h4>THE 7 LEAN FLOWS OF HEALTHCARE</h4>
    <div class="flow-grid">
      ${items.map(i=>`
        <div class="flow-tile">
          <div class="flow-icon ${i.cls}" aria-hidden="true">${i.icon}</div>
          <div><div class="flow-title">${i.k}</div><div class="flow-desc">${i.desc}</div></div>
        </div>`).join('')}
    </div>
  </div>`;
}

/* ===== Content map with diversified visuals ===== */
const reportData={
  /* Patient Care */
  "Patient Care":{title:"Patient Care",description:"Benchmarks related to patient outcomes, satisfaction, and throughput.",
    legendItems:[{color:'red',label:'Demand / Wait Time'},{color:'charcoal',label:'Capacity / Providers'},{color:'good',label:'Positive signal'},{color:'gray',label:'Target / Baseline'}],
    visuals(prefix){return `
      <div class="viz-grid">
        <div class="viz full"><h4>Key Signals</h4>
          <div class="kpis">
            <div class="kpi good"><div class="label">Satisfaction</div><div class="value">92%</div></div>
            <div class="kpi"><div class="label">Avg LOS</div><div class="value">3.1 hrs</div></div>
            <div class="kpi warn"><div class="label">Wait Time</div><div class="value">18m</div></div>
            <div class="kpi"><div class="label">No-Show</div><div class="value">4.8%</div></div>
          </div>
        </div>

        <div class="viz half"><h4>Arrival Peaks (lollipop)</h4>${lollipopChart([55,85,60,90,75,65,40],100)}</div>
        <div class="viz half"><h4>Wait Time Trend (area)</h4>${areaChart([22,18,20,26,19,24,18])}</div>

        <div class="viz half">
          <h4>Capacity vs Target (bullet)</h4>
          ${bulletChart(72,85,100,"Provider Capacity")}
          ${bulletChart(58,60,100,"Room Turnaround")}
        </div>

        <div class="viz half">
          <h4>Utilization Gauge</h4>
          <div style="display:flex;gap:16px;align-items:center;flex-wrap:wrap;">
            ${gaugeSemi(76,"Rooms")}
            ${gaugeSemi(68,"Providers")}
          </div>
        </div>

        <div class="viz half" data-calc="wait" data-prefix="${prefix}">
          <h4>Wait-Time (Erlang-C)</h4>
          <div class="mini-form">
            <div class="f"><label>Arrivals / hr</label><input id="${prefix}-wait-arr" type="number" value="18" min="0" oninput="waitCalc('${prefix}')"></div>
            <div class="f"><label>Service time (min)</label><input id="${prefix}-wait-svc" type="number" value="20" min="1" oninput="waitCalc('${prefix}')"></div>
            <div class="f"><label>Providers (s)</label><input id="${prefix}-wait-srv" type="number" value="6" min="1" oninput="waitCalc('${prefix}')"></div>
            <div class="mini-out" id="${prefix}-wait-out">—</div>
          </div>
          <div class="bar-wrap"><div id="${prefix}-wait-bar" class="bar"></div></div>
          <div class="mini-note" id="${prefix}-wait-note"></div>
        </div>

        <div class="viz half" data-calc="staffing" data-prefix="${prefix}">
          <h4>Staffing Estimator</h4>
          <div class="mini-form">
            <div class="f"><label>Arrivals / hr</label><input id="${prefix}-staff-arr" type="number" value="18" min="0" oninput="staffingCalc('${prefix}')"></div>
            <div class="f"><label>Service time (min / patient)</label><input id="${prefix}-staff-svc" type="number" value="20" min="1" oninput="staffingCalc('${prefix}')"></div>
            <div class="f"><label>Target utilization (%)</label><input id="${prefix}-staff-util" type="number" value="85" min="50" max="100" oninput="staffingCalc('${prefix}')"></div>
            <div class="mini-out" id="${prefix}-staff-out">—</div>
          </div>
          <div class="bar-wrap"><div id="${prefix}-staff-bar" class="bar"></div></div>
          <div class="mini-note" id="${prefix}-staff-note"></div>
        </div>
      </div>`;}
  },

  /* Medication Management */
  "Medication Management":{title:"Medication Management",description:"Benchmarks for medication storage, controls, and administration.",
    legendItems:[{color:'good',label:'Accuracy'},{color:'red',label:'Exceptions'},{color:'gray',label:'Target'}],
    visuals(prefix){return `
      <div class="viz-grid">
        <div class="viz full" data-calc="picking" data-prefix="${prefix}">
          <h4>Pharmacy Picking Productivity</h4>
          <div class="mini-form">
            <div class="f"><label>Orders / hr</label><input id="${prefix}-pick-ord" type="number" value="35" min="0" oninput="pickCalc('${prefix}')"></div>
            <div class="f"><label>Items / order</label><input id="${prefix}-pick-itm" type="number" value="3" min="0" oninput="pickCalc('${prefix}')"></div>
            <div class="f"><label>Sec / pick</label><input id="${prefix}-pick-sec" type="number" value="18" min="0" oninput="pickCalc('${prefix}')"></div>
            <div class="f"><label>Walk/verify (sec / order)</label><input id="${prefix}-pick-walk" type="number" value="20" min="0" oninput="pickCalc('${prefix}')"></div>
            <div class="f"><label>Techs on shift</label><input id="${prefix}-pick-staff" type="number" value="3" min="1" oninput="pickCalc('${prefix}')"></div>
            <div class="mini-out"><span id="${prefix}-pick-out1">—</span></div>
          </div>
          <div class="bar-wrap"><div id="${prefix}-pick-bar" class="bar"></div></div>
          <div class="mini-note" id="${prefix}-pick-note"></div>
          <div class="mini-note"><strong id="${prefix}-pick-out2">—</strong> · <strong id="${prefix}-pick-out3">—</strong></div>
        </div>

        <div class="viz half"><h4>Dispense Accuracy (waffle)</h4>${waffle(99,10)}</div>
        <div class="viz half"><h4>Open Events (heatmap)</h4>${heatmap([[2,1,0,3,2,1,0],[1,0,2,4,3,1,1],[0,1,1,2,2,3,2]],6)}</div>

        <div class="viz full"><h4>Process Mix (stacked)</h4>${stackedBar([[30,20,10],[10,15,35],[25,5,20]],70)}</div>
      </div>`;}
  },

  /* Evidence-Based Design */
  "Evidence-Based Design":{title:"Evidence-Based Design",description:"Design strategies supported by research and best practices.",
    legendItems:[{color:'good',label:'Adoption / Gains'},{color:'red',label:'Gaps'},{color:'gray',label:'Evidence strength'}],
    visuals(prefix){return `
      <div class="viz-grid">
        <div class="viz full" data-calc="roi" data-prefix="${prefix}">
          <h4>ROI on Design Intervention</h4>
          <div class="mini-form">
            <div class="f"><label>Upfront cost ($)</label><input id="${prefix}-roi-cost" type="number" value="250000" min="0" oninput="roiCalc('${prefix}')"></div>
            <div class="f"><label>Annual savings ($)</label><input id="${prefix}-roi-sav" type="number" value="90000" min="0" oninput="roiCalc('${prefix}')"></div>
            <div class="f"><label>Years</label><input id="${prefix}-roi-yrs" type="number" value="7" min="1" oninput="roiCalc('${prefix}')"></div>
            <div class="f"><label>Discount rate (%)</label><input id="${prefix}-roi-disc" type="number" value="5" step="0.1" min="0" oninput="roiCalc('${prefix}')"></div>
            <div class="mini-out">Payback <span id="${prefix}-roi-out1">—</span></div>
          </div>
          <div class="bar-wrap"><div id="${prefix}-roi-bar" class="bar"></div></div>
          <div class="mini-note" id="${prefix}-roi-note"></div>
          <div class="mini-note"><strong>NPV:</strong> <span id="${prefix}-roi-out2">—</span> · <strong>ROI:</strong> <span id="${prefix}-roi-out3">—</span></div>
        </div>

        <div class="viz half"><h4>Interventions Adoption (area)</h4>${areaChart([20,35,50,65,80])}</div>
        <div class="viz half"><h4>Benefit Breakdown (waterfall)</h4>${waterfall([-50,120,30,-20,40],["Cost","Savings","Productivity","Maint.","Net"])}</div>
      </div>`;}
  },

  /* IT & Technology */
  "IT & Technology":{title:"IT & Technology",description:"Benchmarks for digital infrastructure and downtime processes.",
    legendItems:[{color:'good',label:'Uptime'},{color:'red',label:'Incidents'},{color:'gray',label:'Baseline / Hours'}],
    visuals(prefix){return `
      <div class="viz-grid">
        <div class="viz full" data-calc="uptime" data-prefix="${prefix}">
          <h4>Downtime Minutes from Uptime %</h4>
          <div class="mini-form">
            <div class="f"><label>Uptime (%)</label><input id="${prefix}-up-upt" type="number" value="99.9" min="90" max="100" step="0.01" oninput="uptimeCalc('${prefix}')"></div>
            <div class="f"><label>Period (days)</label><input id="${prefix}-up-days" type="number" value="30" min="1" oninput="uptimeCalc('${prefix}')"></div>
            <div class="mini-out" id="${prefix}-up-out">—</div>
          </div>
          <div class="bar-wrap"><div id="${prefix}-up-bar" class="bar"></div></div>
          <div class="mini-note" id="${prefix}-up-note"></div>
        </div>

        <div class="viz half"><h4>Tickets Closed (sparkline)</h4>${sparkline([12,14,18,17,20,22,24])}</div>
        <div class="viz half"><h4>Critical Incidents (bullet)</h4>${bulletChart(6,4,24,"Mean Time To Resolve (hrs)")}</div>

        <div class="viz full"><h4>Service Mix (stacked)</h4>${stackedBar([[18,6,2],[15,9,4],[20,8,3]],32)}</div>
      </div>`;}
  },

  /* Building Metrics */
  "Building Metrics":{title:"Building Metrics",description:"Physical environment benchmarks including air exchanges and acoustics.",
    legendItems:[{color:'red',label:'Hot / High'},{color:'good',label:'On Target'},{color:'gray',label:'Baseline'}],
    visuals(prefix){return `
      <div class="viz-grid">
        <div class="viz full" data-calc="ach" data-prefix="${prefix}">
          <h4>ACH Calculator</h4>
          <div class="mini-form">
            <div class="f"><label>Length (ft)</label><input id="${prefix}-ach-len" type="number" value="20" min="0" oninput="achCalc('${prefix}')"></div>
            <div class="f"><label>Width (ft)</label><input id="${prefix}-ach-wid" type="number" value="12" min="0" oninput="achCalc('${prefix}')"></div>
            <div class="f"><label>Height (ft)</label><input id="${prefix}-ach-ht" type="number" value="9" min="0" oninput="achCalc('${prefix}')"></div>
            <div class="f"><label>Supply CFM</label><input id="${prefix}-ach-cfm" type="number" value="400" min="0" oninput="achCalc('${prefix}')"></div>
            <div class="mini-out" id="${prefix}-ach-out">—</div>
          </div>
          <div class="bar-wrap"><div id="${prefix}-ach-bar" class="bar"></div></div>
          <div class="mini-note" id="${prefix}-ach-note"></div>
        </div>

        <div class="viz third"><h4>Environmental Radar</h4>${radarChart([0.8,0.55,0.7,0.65,0.9])}</div>
        <div class="viz third"><h4>Noise Heatmap</h4>${heatmap([[5,4,6,7,6],[6,5,5,6,7],[7,6,5,6,6]],7)}</div>
        <div class="viz third"><h4>Energy vs Target (bullet)</h4>${bulletChart(74,70,100,"EUI Progress")}</div>
      </div>`;}
  },

  /* Staff Safety */
  "Staff Safety":{title:"Staff Safety",description:"Safety events, injuries, and exposure tracking.",
    legendItems:[{color:'red',label:'Incidents'},{color:'good',label:'Safe days'},{color:'gray',label:'Target'}],
    visuals(){return `
      <div class="viz-grid">
        <div class="viz half"><h4>Recordables (sparkline)</h4>${sparkline([3,2,4,3,5,4,3,2,3,2,1,2])}</div>
        <div class="viz half"><h4>Safe Days (waffle)</h4>${waffle(92,10)}</div>
      </div>`;}
  },

  /* Family Experience */
  "Family Experience":{title:"Family Experience",description:"Family accommodations, amenities, and satisfaction.",
    legendItems:[{color:'good',label:'Positive'},{color:'red',label:'Negative'},{color:'gray',label:'Target'}],
    visuals(){return `
      <div class="viz-grid">
        <div class="viz half"><h4>Family Satisfaction (donut)</h4>${donut(88,"Top-box")}</div>
        <div class="viz half"><h4>Amenities Use (lollipop)</h4>${lollipopChart([20,35,28,42,30,24,18],60)}</div>
      </div>`;}
  },

  /* Supply Chain */
  "Supply Chain":{title:"Supply Chain",description:"Materials management and logistics.",
    legendItems:[{color:'red',label:'Delays'},{color:'good',label:'On-time'},{color:'gray',label:'Baseline'}],
    visuals(){return `
      <div class="viz-grid">
        <div class="viz half"><h4>On-time Deliveries (donut)</h4>${donut(93,"OTIF")}</div>
        <div class="viz half"><h4>Backorders (area)</h4>${areaChart([2,1,1,3,2,4,2,1,2])}</div>
        <div class="viz full"><h4>Lane Risk (heatmap)</h4>${heatmap([[1,2,3,4,5],[2,3,4,3,2],[3,4,5,2,1]],5)}</div>
      </div>`;}
  },

  /* Clinical Metrics */
  "Clinical Metrics":{title:"Clinical Metrics",description:"Performance indicators for clinical outcomes and efficiency.",
    legendItems:[{color:'red',label:'Readmit'},{color:'charcoal',label:'Throughput'},{color:'gray',label:'Target'}],
    visuals(prefix){return `
      <div class="viz-grid">
        <div class="viz half"><h4>LOS Trend (sparkline)</h4>${sparkline([3.1,3.0,2.8,2.9,3.2,3.0,2.7])}</div>
        <div class="viz half"><h4>Readmission Rate (donut)</h4>${donut(9,"30-Day")}</div>
        <div class="viz full"><h4>Throughput (stacked)</h4>${stackedBar([[40,20,10],[50,15,12],[60,18,10]],80)}</div>
        ${flowsTiles()}
      </div>`;}
  }
};

/* ===== render + boot ===== */
function sectionTemplate(key){
  const d=reportData[key];
  const prefix=slug(key)+'-'+Math.random().toString(36).slice(2,6);
  return `<article class="report-section">
    <div class="section-head">
      <div class="section-left"><h3 class="report-title">${d.title}</h3><span class="tag">Interactive Dashboard</span></div>
      <span class="updated">Last updated ${LAST_UPDATED}</span>
    </div>
    ${legend(d.legendItems||[])}
    <p class="report-desc">${d.description}</p>
    ${d.visuals(prefix)}
  </article>`;
}
function initCalcs(scope=document){
  scope.querySelectorAll('[data-calc]').forEach(el=>{
    const t=el.getAttribute('data-calc'), p=el.getAttribute('data-prefix');
    if(t==='staffing') staffingCalc(p);
    if(t==='wait')     waitCalc(p);
    if(t==='picking')  pickCalc(p);
    if(t==='roi')      roiCalc(p);
    if(t==='uptime')   uptimeCalc(p);
    if(t==='ach')      achCalc(p);
  });
}
function generateReport(){
  const selected=[...document.getElementById("categories").selectedOptions].map(o=>o.value);
  const out=document.getElementById("reportOutput");
  out.innerHTML = selected.map(sectionTemplate).join("");
  initCalcs(out);
}

document.addEventListener("DOMContentLoaded",()=>{
  const sel=document.getElementById("categories");

  /* Default: only Patient Care selected */
  [...sel.options].forEach(o => { o.selected = (o.value === "Patient Care"); });

  sel.addEventListener("change",generateReport);
  sel.addEventListener("input",generateReport);
  sel.addEventListener("click",e=>{ if(e.target.tagName==="OPTION") generateReport(); });

  generateReport();

  /* Menu + print */
  const btn=document.getElementById('menuBtn');
  const sheet=document.getElementById('menuSheet');
  const printBtn=document.getElementById('printBtn');
  function closeMenu(){ sheet.classList.remove('open'); btn.setAttribute('aria-expanded','false'); }
  btn.addEventListener('click',e=>{ const open=sheet.classList.toggle('open'); btn.setAttribute('aria-expanded',open?'true':'false'); e.stopPropagation(); });
  document.addEventListener('click',e=>{ if(!sheet.contains(e.target) && e.target!==btn) closeMenu(); });
  printBtn.addEventListener('click',()=>{ closeMenu(); window.print(); });
});
</script>
</body>
</html>
